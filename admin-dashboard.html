<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>

<link rel="stylesheet" href="./style.css">
</head>

<body>

<header>
  <h1>üßë‚Äçüíº Admin Dashboard</h1>
  <button class="btn logout" onclick="logout()">Logout</button>
</header>

<div class="dashboard-container">
  <h2>All Teachers</h2>
  <div id="teachers-list"></div>

  <div id="student-list" style="display:none;">
    <h3 id="class-title"></h3>
    <button class="btn" onclick="generateDefaulter()">Generate Defaulter List</button>
    <div id="students-attendance"></div>
  </div>
</div>

<!-- Firebase libraries (LOAD ONCE, AT BOTTOM) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="./firebase.js"></script>

<script>
const teachersList = document.getElementById("teachers-list");
const studentListDiv = document.getElementById("student-list");
const studentsAttendanceDiv = document.getElementById("students-attendance");
const classTitle = document.getElementById("class-title");

let currentTeacherId = "";
let currentClass = "";

/* ‚úÖ AUTH SAFE ENTRY POINT */
firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "./login.html";
    return;
  }
  loadTeachers();
});

/* LOAD ALL TEACHERS */
function loadTeachers() {
  database.ref("teachers").on("value", snapshot => {
    teachersList.innerHTML = "";

    if (!snapshot.exists()) {
      teachersList.innerHTML = "<p>No teachers found.</p>";
      return;
    }

    snapshot.forEach(teacherSnap => {
      const teacher = teacherSnap.val();
      const card = document.createElement("div");
      card.className = "teacher-card";

      let classesHTML = "<li>No classes</li>";
      if (teacher.classes) {
        classesHTML = Object.keys(teacher.classes)
          .map(c =>
            `<li>${c}
              <button class="btn" onclick="viewClass('${teacherSnap.key}','${c}')">
                View Students
              </button>
            </li>`
          ).join("");
      }

      card.innerHTML = `
        <h3>${teacher.name || "No Name"} (${teacher.email || "No Email"})</h3>
        <p>Classes:</p>
        <ul>${classesHTML}</ul>
      `;

      teachersList.appendChild(card);
    });
  });
}

/* VIEW STUDENTS OF A CLASS */
function viewClass(teacherId, className) {
  currentTeacherId = teacherId;
  currentClass = className;
  classTitle.textContent = `Class: ${className}`;
  studentsAttendanceDiv.innerHTML = "";
  studentListDiv.style.display = "block";

  database.ref(`teachers/${teacherId}/classes/${className}/students`)
    .once("value", snap => {
      if (!snap.exists()) {
        studentsAttendanceDiv.innerHTML = "No students found.";
        return;
      }

      snap.forEach(studentSnap => {
        const div = document.createElement("div");
        div.textContent = `${studentSnap.val().name || "No Name"} (Roll: ${studentSnap.key})`;
        studentsAttendanceDiv.appendChild(div);
      });
    });
}

/* GENERATE DEFAULTER LIST */
function generateDefaulter() {
  const date = prompt(
    "Enter date (YYYY-MM-DD):",
    new Date().toISOString().split("T")[0]
  );

  if (!date) return;

  database.ref(`teachers/${currentTeacherId}/classes/${currentClass}/attendance/${date}`)
    .once("value", snap => {
      if (!snap.exists()) {
        alert("No attendance data for this date.");
        return;
      }

      let defaulters = [];
      snap.forEach(s => {
        if (s.val() === "absent") defaulters.push(s.key);
      });

      alert(
        defaulters.length
          ? `Defaulters (${date}):\n${defaulters.join(", ")}`
          : "No defaulters üéâ"
      );
    });
}

/* LOGOUT */
function logout() {
  firebase.auth().signOut().then(() => {
    window.location.href = "./login.html";
  });
}
</script>

</body>
</html>
