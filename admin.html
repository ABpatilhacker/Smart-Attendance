<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="firebase.js"></script>
</head>
<body>
<header class="dashboard-header">
  <h1>ğŸ§‘â€ğŸ’¼ Admin Dashboard</h1>
  <button class="btn logout" onclick="firebase.auth().signOut().then(()=>window.location='index.html')">Logout</button>
</header>

<div class="dashboard-content">
  <h2>All Teachers</h2>
  <div id="teachers-list"></div>

  <div id="student-list" class="hidden">
    <h3 id="class-title"></h3>
    <button class="btn" onclick="generateDefaulter()">Generate Defaulter List</button>
    <div id="students-attendance"></div>
  </div>
</div>

<script>
firebase.auth().onAuthStateChanged(user => { if(!user) window.location='index.html'; });

const teachersList = document.getElementById("teachers-list");
const studentListDiv = document.getElementById("student-list");
const studentsAttendanceDiv = document.getElementById("students-attendance");
const classTitle = document.getElementById("class-title");

database.ref("teachers").on("value", snapshot => {
  teachersList.innerHTML = "";
  snapshot.forEach(teacherSnap => {
    const teacher = teacherSnap.val();
    const teacherCard = document.createElement("div");
    teacherCard.className = "teacher-card";
    teacherCard.innerHTML = `
      <h3>${teacher.name} (${teacher.email})</h3>
      <p>Classes:</p>
      <ul>
        ${teacher.classes ? Object.keys(teacher.classes).map(c => `<li>${c} <button class="btn" onclick="viewClass('${teacherSnap.key}','${c}')">View</button></li>`).join('') : "<li>No classes</li>"}
      </ul>
    `;
    teachersList.appendChild(teacherCard);
  });
});

let currentTeacherId = "";
let currentClass = "";

function viewClass(teacherId, className) {
  currentTeacherId = teacherId;
  currentClass = className;
  classTitle.textContent = `Class: ${className}`;
  studentsAttendanceDiv.innerHTML = "";
  studentListDiv.classList.remove('hidden');

  database.ref(`teachers/${teacherId}/classes/${className}/students`).once("value", snap => {
    if(!snap.exists()) { studentsAttendanceDiv.innerHTML = "No students"; return; }
    snap.forEach(studentSnap => {
      const student = studentSnap.val();
      const div = document.createElement("div");
      div.textContent = `${student.name} (Roll: ${studentSnap.key})`;
      studentsAttendanceDiv.appendChild(div);
    });
  });
}

function generateDefaulter() {
  const date = prompt("Enter date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
  if(!date) return;

  database.ref(`teachers/${currentTeacherId}/classes/${currentClass}/attendance/${date}`).once("value", snap => {
    if(!snap.exists()) { alert("No attendance for this date."); return; }
    let defaulters = [];
    snap.forEach(studentSnap => { if(studentSnap.val() === "absent") defaulters.push(studentSnap.key); });
    alert(`Defaulters: ${defaulters.join(", ") || "None"}`);
  });
}
</script>
</body>
</html>
